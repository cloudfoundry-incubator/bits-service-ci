bosh1-params: &bosh1-params
  BOSH_TARGET: {{bosh-target}}
  BOSH_USERNAME: {{bosh-username}}
  BOSH_PASSWORD: {{bosh-password}}

sl-bosh-params: &sl-bosh-params
  BOSH_TARGET: {{sl-bosh-target}}
  BOSH_USERNAME: {{sl-bosh-username}}
  BOSH_PASSWORD: {{sl-bosh-password}}
  ENVIRONMENT_NAME: softlayer

bosh2-params: &bosh2-params
  BOSH_TARGET: {{bosh2-target}}
  BOSH_USERNAME: {{bosh2-username}}
  BOSH_PASSWORD: {{bosh2-password}}

aws-bosh-params: &aws-bosh-params
  BOSH_TARGET: {{aws-bosh-target}}
  BOSH_USERNAME: {{aws-bosh-username}}
  BOSH_PASSWORD: {{aws-bosh-password}}

boshlite2-bsmt-preparation-errand-params: &boshlite2-bsmt-preparation-errand-params
  <<: *bosh2-params
  DEPLOYMENT_NAME: cf
  ERRAND_NAME: bsmt_preparation
  EXTRA_ARGS: --keep-alive

boshlite2-bsmt-verification-errand-params: &boshlite2-bsmt-verification-errand-params
  <<: *bosh2-params
  DEPLOYMENT_NAME: cf
  ERRAND_NAME: bsmt_verification
  EXTRA_ARGS: --keep-alive

boshlite1-bsmt-verification-errand-params: &boshlite1-bsmt-verification-errand-params
  <<: *bosh1-params
  DEPLOYMENT_NAME: cf
  ERRAND_NAME: bsmt_verification
  EXTRA_ARGS: --keep-alive

notify: &notify
  put: slack
  params:
    text: |
      $TEXT_FILE_CONTENT The Concourse pipeline broke. See:
      $ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME
    text_file: points-of-contact/slack-users-single-line

jobs:
# BITS-SERVICE
- name: run-unit-and-integration-tests
  plan:
  - aggregate:
    - { get: bits-service, trigger: true }
    - { get: ci-tasks, resource: git-bits-service-ci, trigger: true }
  - task: Run tests
    attempts: 3
    file: ci-tasks/tasks/run-service-tests.yml
  on_failure: *notify

- name: bump-bits-service-release
  plan:
  - aggregate:
    - { get: bits-service, passed: [run-unit-and-integration-tests], trigger: true }
    - { get: ci-tasks, resource: git-bits-service-ci, trigger: true }
    - { get: git-bits-service-release }
  - task: Bump bits-service-release
    file: ci-tasks/tasks/bump-release.yml
  - put: git-bits-service-release
    params: {repository: bumped/git-bits-service-release}
  on_failure: *notify

- name: run-bits-service-client-tests
  serial: true
  plan:
  - { get: git-bits-service-client, trigger: true }
  - { get: ci-tasks, resource: git-bits-service-ci, trigger: true }
  - task: Run tests
    file: ci-tasks/tasks/run-bits-service-client-tests.yml
  on_failure: *notify

- name: Publish gem
  serial: true
  plan:
  - { get: git-bits-service-client, passed: [run-bits-service-client-tests], trigger: true }
  - { get: ci-tasks, resource: git-bits-service-ci, trigger: true }
  - task: Publish to rubygems.org
    file: ci-tasks/tasks/publish-gem.yml
    params:
      GIT_PRIVATE_KEY: {{github-private-key}}
      RUBYGEMS_API_KEY: {{rubygems-api-key}}
  on_failure: *notify

- name: create-and-upload-release
  plan:
  - aggregate:
    - { get: bits-service-release-version, params: { pre: dev } }
    - { get: git-bits-service-release, trigger: true }
    - { get: ci-tasks, resource: git-bits-service-ci, trigger: true }
  - put: bits-service-release-version
    params: { file: bits-service-release-version/version }
  - task: Create release
    file: ci-tasks/tasks/create-bits-release.yml
    params: { VERSION_FILE: bits-service-release-version/version }
  - put: bits-service-release-tarball
    params: { file: releases/*.tgz }
  - put: git-bits-service-release
    params:
      repository: git-bits-service-release
      tag: bits-service-release-version/version
      only_tag: true
  on_failure: *notify

- name: deploy-with-S3
  serial: true
  serial_groups: [bits-deployment-s3]
  plan:
  - aggregate:
    - { get: bits-service-release-tarball, passed: [create-and-upload-release], trigger: true }
    - { get: bits-service-release-version, passed: [create-and-upload-release] }
    - { get: git-bits-service-release, passed: [create-and-upload-release], trigger: true }
    - { get: ci-tasks, resource: git-bits-service-ci, trigger: true }
    - { get: stemcell, resource: softlayer-stemcell }
    - { get: git-deployment-vars }
  - task: Create deployment manifest
    file: ci-tasks/tasks/create-bits-manifest.yml
    input_mapping:
      bits-service-deployment-manifest-generation-tools: git-bits-service-release
      bits-service-private-config: git-deployment-vars
    params:
      <<: *sl-bosh-params
      BITS_DIRECTORY_KEY: {{s3-blobstore-bucket-name}}
      BITS_AWS_REGION: {{s3-blobstore-region}}
      AWS_ACCESS_KEY_ID: {{s3-blobstore-access-key-id}}
      AWS_SECRET_ACCESS_KEY: {{s3-blobstore-secret-access-key}}
      BLOBSTORE_TYPE: s3
      BITS_SERVICE_JOB_IP: &bits_service_job_ip_s3 10.175.96.246
      BLOBSTORE_JOB_IP: 10.175.96.247
      DEPLOYMENT_NAME: bits-service-s3
  - aggregate:
    - put: git-deployment-vars
      params:
        repository: updated/bits-service-private-config
    - put: bosh-deployment-bits-service-s3
      attempts: 3
      params: &sl-bits-service-deployment-params
        manifest: manifests/manifest.yml
        stemcells: ["stemcell/stemcell.tgz"]
        releases: ["bits-service-release-tarball/*.tgz"]
        no_redact: true
  on_failure: *notify

- name: run-system-tests-S3
  serial: true
  serial_groups: [bits-deployment-s3]
  plan:
  - aggregate:
    - { get: bits-service-release-tarball, passed: [deploy-with-S3], trigger: true }
    - { get: bits-service-release-version, passed: [deploy-with-S3] }
    - { get: git-bits-service-release, passed: [deploy-with-S3] }
    - { get: ci-tasks, resource: git-bits-service-ci }
    - { get: git-deployment-vars }
  - task: Run tests
    attempts: 3
    file: ci-tasks/tasks/run-release-tests.yml
    input_mapping:
      bits-service-system-test-source: git-bits-service-release
      deployment-vars: git-deployment-vars
    params:
      <<: *sl-bosh-params
      BITS_SERVICE_PRIVATE_ENDPOINT_IP: *bits_service_job_ip_s3
      RELEASE_NAME: bits-service-s3
      DEPLOYMENT_NAME: bits-service-s3
  on_failure: *notify

- name: deploy-with-LOCAL
  serial: true
  serial_groups: [bits-deployment-local]
  plan:
  - aggregate:
    - { get: bits-service-release-tarball, passed: [create-and-upload-release], trigger: true }
    - { get: bits-service-release-version, passed: [create-and-upload-release] }
    - { get: git-bits-service-release, passed: [create-and-upload-release], trigger: true }
    - { get: ci-tasks, resource: git-bits-service-ci, trigger: true}
    - { get: stemcell, resource: softlayer-stemcell }
    - { get: git-deployment-vars }
  - task: Create deployment manifest
    file: ci-tasks/tasks/create-bits-manifest.yml
    input_mapping:
      bits-service-deployment-manifest-generation-tools: git-bits-service-release
      bits-service-private-config: git-deployment-vars
    params:
      <<: *sl-bosh-params
      BLOBSTORE_TYPE: local
      BITS_SERVICE_JOB_IP: &bits_service_job_ip_local 10.175.96.242
      BLOBSTORE_JOB_IP: 10.175.96.243
      DEPLOYMENT_NAME: bits-service-local
  - aggregate:
    - put: git-deployment-vars
      params:
        repository: updated/bits-service-private-config
    - put: bosh-deployment-bits-service-local
      attempts: 3
      params: *sl-bits-service-deployment-params
  on_failure: *notify

- name: run-system-tests-LOCAL
  serial: true
  serial_groups: [bits-deployment-local]
  plan:
  - aggregate:
    - { get: bits-service-release-tarball, passed: [deploy-with-LOCAL], trigger: true }
    - { get: bits-service-release-version, passed: [deploy-with-LOCAL] }
    - { get: git-bits-service-release, passed: [deploy-with-LOCAL]}
    - { get: ci-tasks, resource: git-bits-service-ci }
    - { get: git-deployment-vars }
  - task: Run tests
    attempts: 3
    file: ci-tasks/tasks/run-release-tests.yml
    input_mapping:
      bits-service-system-test-source: git-bits-service-release
      deployment-vars: git-deployment-vars
    params:
      <<: *sl-bosh-params
      BITS_SERVICE_PRIVATE_ENDPOINT_IP: *bits_service_job_ip_local
      RELEASE_NAME: bits-service-local
      DEPLOYMENT_NAME: bits-service-local
  on_failure: *notify

- name: deploy-with-WEBDAV
  serial: true
  serial_groups: [bits-deployment-webdav]
  plan:
  - aggregate:
    - { get: bits-service-release-tarball, passed: [create-and-upload-release], trigger: true }
    - { get: bits-service-release-version, passed: [create-and-upload-release] }
    - { get: git-bits-service-release, passed: [create-and-upload-release], trigger: true }
    - { get: ci-tasks, resource: git-bits-service-ci, trigger: true}
    - { get: stemcell, resource: softlayer-stemcell }
    - { get: git-deployment-vars }
  - task: Create deployment manifest
    file: ci-tasks/tasks/create-bits-manifest.yml
    input_mapping:
      bits-service-deployment-manifest-generation-tools: git-bits-service-release
      bits-service-private-config: git-deployment-vars
    params:
      <<: *sl-bosh-params
      BLOBSTORE_TYPE: webdav
      BITS_SERVICE_JOB_IP: &bits_service_job_ip_webdav 10.175.96.244
      BLOBSTORE_JOB_IP: 10.175.96.245
      DEPLOYMENT_NAME: bits-service-webdav
  - aggregate:
    - put: git-deployment-vars
      params:
        repository: updated/bits-service-private-config
    - put: bosh-deployment-bits-service-webdav
      attempts: 3
      params: *sl-bits-service-deployment-params
  on_failure: *notify

- name: run-system-tests-WEBDAV
  serial: true
  serial_groups: [bits-deployment-webdav]
  plan:
  - aggregate:
    - { get: bits-service-release-tarball, passed: [deploy-with-WEBDAV], trigger: true }
    - { get: bits-service-release-version, passed: [deploy-with-WEBDAV] }
    - { get: git-bits-service-release, passed: [deploy-with-WEBDAV] }
    - { get: ci-tasks, resource: git-bits-service-ci }
    - { get: git-deployment-vars }
  - task: Run tests
    timeout: 5m
    attempts: 3
    file: ci-tasks/tasks/run-release-tests.yml
    input_mapping:
      bits-service-system-test-source: git-bits-service-release
      deployment-vars: git-deployment-vars
    params:
      <<: *sl-bosh-params
      BITS_SERVICE_PRIVATE_ENDPOINT_IP: *bits_service_job_ip_webdav
      RELEASE_NAME: bits-service-webdav
      DEPLOYMENT_NAME: bits-service-webdav
  on_failure: *notify

- name: deploy-and-test-with-s3-cf-softlayer
  serial: true
  serial_groups: [cf-softlayer-deployment-s3]
  plan:
  - aggregate:
    - { get: capi-release-tarball, passed: [create-capi-release], trigger: true }
    - { get: bits-service-release-tarball, passed: [create-and-upload-release], trigger: true }
    - { get: bits-service-release-version, passed: [create-and-upload-release] }
    - { get: git-bits-service-release, passed: [create-and-upload-release], trigger: true }
    - { get: stemcell, resource: softlayer-stemcell }
    - { get: ci-tasks, resource: git-bits-service-ci, trigger: true }
    - { get: git-cf-deployment, trigger: true }
    - { get: git-deployment-vars }
  - task: Generate CF deployment manifest with bits-service enabled
    file: ci-tasks/tasks/bosh-interpolate.yml
    input_mapping:
      cf-deployment: git-cf-deployment
      deployment-vars: git-deployment-vars
    output_mapping:
      manifests: cf-with-bits-service-enabled
    params: &bosh-interpolate-softlayer-bits-service-enabled
      BOSH_TARGET: {{sl-bosh-target}}
      DEPLOYMENT_NAME: cf
      ENVIRONMENT_NAME: softlayer
      BLOBSTORE_TYPE: s3
      IAAS: softlayer
      CF_DOMAIN: {{sl-cf1-domain}}
      OPERATIONS: >
        -o cf-deployment/operations/scale-to-one-az.yml
      VARIABLES: >
        -v aws_region={{s3-blobstore-region}}
        -v blobstore_access_key_id={{s3-blobstore-access-key-id}}
        -v blobstore_secret_access_key={{s3-blobstore-secret-access-key}}
        -v resource_directory_key={{s3-blobstore-bucket-name}}
        -v buildpack_directory_key={{s3-blobstore-bucket-name}}
        -v droplet_directory_key={{s3-blobstore-bucket-name}}
        -v app_package_directory_key={{s3-blobstore-bucket-name}}
  - aggregate:
    - put: git-deployment-vars
      params:
        repository: updated/deployment-vars
    - put: softlayer-cf-deployment
      attempts: 2
      params:
        manifest: cf-with-bits-service-enabled/manifest.yml
        stemcells: ["stemcell/stemcell.tgz"]
        releases: ["capi-release-tarball/*.tgz", "bits-service-release-tarball/*.tgz"]
        no_redact: true
  - task: Run tests
    timeout: 5m
    attempts: 3
    file: ci-tasks/tasks/run-system-tests.yml
    input_mapping:
      bits-service-system-test-source: git-bits-service-release
      deployment-vars: git-deployment-vars
    params:
      <<: *sl-bosh-params
      DEPLOYMENT_NAME: cf
      ENVIRONMENT_NAME: softlayer
      CF_DOMAIN: {{sl-cf1-domain}}
  on_failure: *notify

# CAPI-RELEASE
- name: create-capi-release
  serial: true
  plan:
  - aggregate:
    - { get: capi-release-version, params: { pre: dev } }
    - { get: git-capi-release, trigger: true }
    - { get: ci-tasks, resource: git-bits-service-ci, trigger: true }
    - { get: git-bits-service-client, passed: [Publish gem], trigger: true }
  - task: "Patch: Consume latest prerelease of bits_service_client"
    file: ci-tasks/tasks/patch-cc-to-use-bits-service-client-latest-prerelease.yml
    input_mapping:
      capi-release: git-capi-release
  - task: Show patched CC Gemfile.lock
    file: ci-tasks/tasks/show-patched-cc.yml
  - task: Create capi-release tarball
    file: ci-tasks/tasks/create-capi-release.yml
    input_mapping:
      capi-release: patched-capi-release
    params:
      VERSION_FILE: capi-release-version/number
  - put: capi-release-tarball
    params: { file: releases/*.tgz }
  - put: capi-release-version
    params: { file: capi-release-version/number }
  on_failure: *notify

- name: Publish Dev Release
  plan:
  - aggregate:
    - get: capi-release-tarball
      passed: &migration-tests-passed
        - enable-BITS-SERVICE-diego-and-run-CATs
        - migration-backwards-bosh1
        - migration-backwards-bosh2
      trigger: true
    - { get: ci-tasks, resource: git-bits-service-ci, trigger: true }
    - { get: bits-service-release-tarball, passed: *migration-tests-passed, trigger: true }
    - { get: bits-service-release-version, passed: *migration-tests-passed }
  - aggregate:
    - task: Publish release tarball URLs
      file: ci-tasks/tasks/publish-release-tarball-urls.yml
      params:
        RELEASE_TARBALL_DIRS: capi-release-tarball bits-service-release-tarball
    - put: bits-service-github-release
      params:
        name: bits-service-release-version/version
        tag: bits-service-release-version/version
        globs: [ "bits-service-release-tarball/*.tgz" ]
  on_failure: *notify

- name: Publish Final Release
  plan:
  - aggregate:
    - get: git-bits-service-release
      passed: *migration-tests-passed
    - get: bits-service-release-version
      passed:
        - enable-BITS-SERVICE-diego-and-run-CATs
        - migration-backwards-bosh1
        - migration-backwards-bosh2
      params: { bump: minor }
    - get: ci-tasks
      resource: git-bits-service-ci
  - task: promote release
    file: ci-tasks/tasks/promote-bits-service-final-release.yml
    input_mapping:
      release-version: bits-service-release-version
      release-git-repo: git-bits-service-release
    params:
      PRIVATE_YML_CONTENT: {{private-yml}}
  - aggregate:
    - put: bits-service-github-final-release
      params:
        name: bits-service-release-version/version
        tag: bits-service-release-version/version
        only_tag: true
        globs: [ "release-tarball/*.tgz" ]
    - put: bits-service-release-version
      params: { file: bits-service-release-version/version }
    - put: git-bits-service-release
      params: { repository: release-git-repo-final }

  on_failure: *notify

- name: manually-delete-cf-diego-aws
  serial: true
  plan:
  - aggregate:
    - { get: ci-tasks, resource: git-bits-service-ci }
    - { get: cf-diego-aws-deployment-events, params: { bump: major } }
  - task: delete-deployment
    file: ci-tasks/tasks/delete-deployment.yml
    params:
      <<: *aws-bosh-params
      DEPLOYMENT_NAME: cf
  - put: cf-diego-aws-deployment-events
    params: { file: cf-diego-aws-deployment-events/number }
  on_failure: *notify

- name: deploy-and-test-cf-diego-aws
  serial: true
  serial_groups: [cf-aws-deployment]
  plan:
  - aggregate:
    - { get: capi-release-tarball, passed: [create-capi-release], trigger: true }
    - get: bits-service-release-tarball
      passed: &run-system-tests-passed
        - run-system-tests-LOCAL
        - run-system-tests-S3
        - run-system-tests-WEBDAV
        - deploy-and-test-with-s3-cf-softlayer
      trigger: true
    - { get: bits-service-release-version, passed: *run-system-tests-passed }
    - { get: cf-diego-aws-deployment-events, trigger: true}
    - { get: stemcell, resource: aws-stemcell, trigger: true }
    - { get: ci-tasks, resource: git-bits-service-ci, trigger: true }
    - { get: git-cf-deployment, trigger: true }
    - { get: git-deployment-vars }
    - { get: git-cf-acceptance-tests, trigger: true }
    - { get: git-bits-service-release, passed: *run-system-tests-passed, trigger: true }
  - task: Generate CF deployment manifest with bits-service disabled
    file: ci-tasks/tasks/bosh-interpolate.yml
    input_mapping:
      cf-deployment: git-cf-deployment
      deployment-vars: git-deployment-vars
    output_mapping:
      manifests: cf-with-bits-service-disabled
    params: &bosh-interpolate-aws-bits-service-disabled
      BOSH_TARGET: {{aws-bosh-target}}
      DEPLOYMENT_NAME: cf
      ENVIRONMENT_NAME: aws
      BLOBSTORE_TYPE: s3
      IAAS: aws
      CF_DOMAIN: {{aws-cf1-domain}}
      OPERATIONS: >
        -o cf-deployment/operations/scale-to-one-az.yml
        -o cf-deployment/operations/use-s3-blobstore.yml
        -o ci-tasks/operations/disable-bits-service.yml
      VARIABLES: >
        -v aws_region={{cf-migration-s3-blobstore-region}}
        -v blobstore_access_key_id={{cf-migration-s3-blobstore-access-key-id}}
        -v blobstore_secret_access_key={{cf-migration-s3-blobstore-secret-access-key}}
        -v resource_directory_key={{cf-migration-s3-blobstore-bucket-name}}
        -v buildpack_directory_key={{cf-migration-s3-blobstore-bucket-name}}
        -v droplet_directory_key={{cf-migration-s3-blobstore-bucket-name}}
        -v app_package_directory_key={{cf-migration-s3-blobstore-bucket-name}}
  - aggregate:
    - put: git-deployment-vars
      params:
        repository: updated/deployment-vars
    - put: aws-diego-deployment
      attempts: 2
      params: &params-aws-deployment-bits-service-disabled
        manifest: cf-with-bits-service-disabled/manifest.yml
        stemcells: ["stemcell/stemcell.tgz"]
        releases: ["capi-release-tarball/*.tgz", "bits-service-release-tarball/*.tgz"]
        no_redact: true
  - task: Run CATs
    file: ci-tasks/tasks/run-cats.yml
    input_mapping:
      deployment-vars: git-deployment-vars
      acceptance-tests: git-cf-acceptance-tests
    attempts: 3
    params:
      <<: *aws-bosh-params
      DEPLOYMENT_NAME: cf
      ENVIRONMENT_NAME: aws
      CF_DOMAIN: {{aws-cf1-domain}}
    on_failure: &inform-pipeline-operator-diego-aws-cats
      task: inform-pipeline-operator
      file: ci-tasks/tasks/echo.yml
      params:
        MESSAGE: |
            Consider doing a fresh deployment by manually running job
            [manually-delete-cf-diego-aws]
            (https://flintstone.ci.cf-app.com/pipelines/bits-service/jobs/manually-delete-cf-diego-aws)
  on_failure: *notify

- name: enable-BITS-SERVICE-diego-and-run-CATs
  serial: true
  serial_groups: [cf-aws-deployment]
  plan:
  - aggregate:
    - { get: capi-release-tarball, passed: [deploy-and-test-cf-diego-aws], trigger: true }
    - { get: bits-service-release-tarball, passed: [deploy-and-test-cf-diego-aws], trigger: true }
    - { get: bits-service-release-version, passed: [deploy-and-test-cf-diego-aws] }
    - { get: stemcell, resource: aws-stemcell, passed: [deploy-and-test-cf-diego-aws], trigger: true }
    - { get: ci-tasks, resource: git-bits-service-ci, passed: [deploy-and-test-cf-diego-aws], trigger: true}
    - { get: git-cf-deployment, passed: [deploy-and-test-cf-diego-aws], trigger: true }
    - { get: git-deployment-vars }
    - { get: git-cf-acceptance-tests, passed: [deploy-and-test-cf-diego-aws], trigger: true }
    - { get: git-bits-service-release, passed: [deploy-and-test-cf-diego-aws], trigger: true }
  - task: Generate CF deployment manifest with bits-service enabled
    file: ci-tasks/tasks/bosh-interpolate.yml
    input_mapping:
      cf-deployment: git-cf-deployment
      deployment-vars: git-deployment-vars
    output_mapping:
      manifests: cf-with-bits-service-enabled
    params: &bosh-interpolate-aws-bits-service-enabled
      <<: *bosh-interpolate-aws-bits-service-disabled
      OPERATIONS: >
        -o cf-deployment/operations/scale-to-one-az.yml
        -o cf-deployment/operations/use-s3-blobstore.yml
  - put: git-deployment-vars
    params:
      repository: updated/deployment-vars
  - put: aws-diego-deployment
    attempts: 2
    params: &params-aws-deployment-bits-service-enabled
      <<: *params-aws-deployment-bits-service-disabled
      manifest: cf-with-bits-service-enabled/manifest.yml
  - task: Run CATs
    file: ci-tasks/tasks/run-cats.yml
    input_mapping:
      deployment-vars: git-deployment-vars
      acceptance-tests: git-cf-acceptance-tests
    attempts: 3
    params:
      <<: *aws-bosh-params
      DEPLOYMENT_NAME: cf
      ENVIRONMENT_NAME: aws
      CF_DOMAIN: {{aws-cf1-domain}}
    on_failure: *inform-pipeline-operator-diego-aws-cats
  on_failure: *notify

# delete standalone bits-service deployment
- name: delete-deployment-bits-service-local
  plan:
    - { get: ci-tasks, resource: git-bits-service-ci }
    - task: delete-deployment
      file: ci-tasks/tasks/delete-deployment.yml
      params:
        <<: *sl-bosh-params
        DEPLOYMENT_NAME: bits-service-local
  on_failure: *notify

- name: delete-deployment-bits-service-webdav
  plan:
    - { get: ci-tasks, resource: git-bits-service-ci }
    - task: delete-deployment
      file: ci-tasks/tasks/delete-deployment.yml
      params:
        <<: *sl-bosh-params
        DEPLOYMENT_NAME: bits-service-webdav
  on_failure: *notify

- name: delete-deployment-bits-service-s3
  plan:
    - { get: ci-tasks, resource: git-bits-service-ci }
    - task: delete-deployment
      file: ci-tasks/tasks/delete-deployment.yml
      params:
        <<: *sl-bosh-params
        DEPLOYMENT_NAME: bits-service-s3
  on_failure: *notify

# Migration
- name: manually-delete-cf-bosh1
  serial: true
  plan:
  - aggregate:
    - { get: ci-tasks, resource: git-bits-service-ci }
    - get: cf-bosh1-deployment-events
      params: { bump: major }
  - task: delete-deployment
    file: ci-tasks/tasks/delete-deployment.yml
    params:
      <<: *bosh1-params
      DEPLOYMENT_NAME: cf
  - put: cf-bosh1-deployment-events
    params: { file: cf-bosh1-deployment-events/number }
  on_failure: *notify

- name: update-cloud-config-bosh1
  plan:
  - aggregate:
    - { get: bosh1-recreation-events, trigger: true }
    - { get: ci-tasks, resource: git-bits-service-ci }
    - { get: git-cf-deployment-cloud-config, trigger: true }
  - task: Update cloud-config
    file: ci-tasks/tasks/update-cloud-config.yml
    input_mapping:
      manifests: git-cf-deployment-cloud-config
    params:
      <<: *bosh1-params
      MANIFEST: *bosh-lite-cloud-config-path
  on_failure: *notify

- name: migration-bosh1 (S3)
  serial: true
  serial_groups: [cf-bosh1-deployment]
  plan:
  - aggregate:
    - { get: capi-release-tarball, passed: [create-capi-release], trigger: true }
    - { get: bits-service-release-tarball, passed: *run-system-tests-passed, trigger: true }
    - { get: bits-service-release-version, passed: *run-system-tests-passed }
    - { get: cf-bosh1-deployment-events, trigger: true }
    - { get: stemcell, resource: boshlite-stemcell }
    - { get: ci-tasks, resource: git-bits-service-ci, trigger: true }
    - { get: git-cf-deployment, trigger: true }
    - { get: bosh1-recreation-events, passed: [ update-cloud-config-bosh1 ], trigger: true }
    - { get: git-cf-deployment-cloud-config, passed: [ update-cloud-config-bosh1 ], trigger: true }
    - { get: git-deployment-vars }
    - { get: git-bits-service-release, passed: *run-system-tests-passed, trigger: true }
  - task: Generate CF deployment manifest with bits-service disabled
    file: ci-tasks/tasks/bosh-interpolate.yml
    input_mapping:
      cf-deployment: git-cf-deployment
      deployment-vars: git-deployment-vars
    output_mapping:
      manifests: cf-with-bits-service-disabled
    params: &bosh-interpolate-boshlite1-bits-service-disabled
      BOSH_TARGET: {{bosh-target}}
      DEPLOYMENT_NAME: cf
      ENVIRONMENT_NAME: bosh1
      BLOBSTORE_TYPE: s3
      IAAS: bosh-lite
      OPERATIONS: >
        -o cf-deployment/operations/use-s3-blobstore.yml
        -o ci-tasks/operations/disable-bits-service.yml
        -o ci-tasks/operations/bsmt-errands.yml
      VARIABLES: >
        -v aws_region={{cf-migration-s3-blobstore-region}}
        -v blobstore_access_key_id={{cf-migration-s3-blobstore-access-key-id}}
        -v blobstore_secret_access_key={{cf-migration-s3-blobstore-secret-access-key}}
        -v resource_directory_key={{cf-migration-s3-blobstore-bucket-name}}
        -v buildpack_directory_key={{cf-migration-s3-blobstore-bucket-name}}
        -v droplet_directory_key={{cf-migration-s3-blobstore-bucket-name}}
        -v app_package_directory_key={{cf-migration-s3-blobstore-bucket-name}}
      CF_DOMAIN: boshlite1.dynamic-dns.net
  - put: git-deployment-vars
    params:
      repository: updated/deployment-vars
  - put: boshlite1-deployment
    params: &params-deployment-bits-service-disabled
      manifest: cf-with-bits-service-disabled/manifest.yml
      stemcells: ["stemcell/stemcell.tgz"]
      releases: ["capi-release-tarball/*.tgz", "bits-service-release-tarball/*.tgz"]
      no_redact: true
  - task: Run migration preparation tests
    attempts: 3
    file: ci-tasks/tasks/run-bits-service-migration-tests.yml
    input_mapping:
      bits-service-release: git-bits-service-release
      deployment-vars: git-deployment-vars
    params: &boshlite1-bsmt-preparation-params
      test_suite: preparation
      CF_DOMAIN: boshlite1.dynamic-dns.net
      SSH_CONNECTION_STRING: root@10.155.171.3
      SSH_KEY: {{github-private-key}}
      BSMT_PERSISTENT_ORG: BSMT-persistent-org
      BSMT_PERSISTENT_SPACE: BSMT-persistent-space
      REMOTE_HOST: 10.155.171.3
      DEBUG: true
      DEPLOYMENT_VARS_FILE: deployment-vars/environments/bosh1/deployment-vars-cf.yml
    on_failure: &inform-pipeline-operator-bosh1-migration-tests
      task: inform-pipeline-operator
      file: ci-tasks/tasks/echo.yml
      params:
        MESSAGE: |
            Consider doing a fresh deployment by manually running job
            [manually-delete-cf-bosh1]
            (https://flintstone.ci.cf-app.com/pipelines/bits-service/jobs/manually-delete-cf-bosh1)
  - task: Generate CF deployment manifest with bits-service enabled
    file: ci-tasks/tasks/bosh-interpolate.yml
    input_mapping:
      cf-deployment: git-cf-deployment
      deployment-vars: git-deployment-vars
    output_mapping:
      manifests: cf-with-bits-service-enabled
    params: &bosh-interpolate-boshlite1-bits-service-enabled
      <<: *bosh-interpolate-boshlite1-bits-service-disabled
      OPERATIONS: >
        -o cf-deployment/operations/use-s3-blobstore.yml
        -o ci-tasks/operations/bsmt-errands.yml
  - put: boshlite1-deployment
    params: &params-deployment-bits-service-enabled
      <<: *params-deployment-bits-service-disabled
      manifest: cf-with-bits-service-enabled/manifest.yml
  - put: git-deployment-vars
    params:
      repository: updated/deployment-vars
  - task: Run migration verification tests
    attempts: 3
    file: ci-tasks/tasks/run-bits-service-migration-tests.yml
    input_mapping:
      bits-service-release: git-bits-service-release
      deployment-vars: git-deployment-vars
    params: &boshlite1-bsmt-verification-params
      <<: *boshlite1-bsmt-preparation-params
      test_suite: verification
    on_failure: *inform-pipeline-operator-bosh1-migration-tests
  on_failure: *notify

- name: migration-backwards-bosh1
  serial: true
  serial_groups: [cf-bosh1-deployment]
  plan:
  - aggregate:
    - { get: capi-release-tarball, passed: [migration-bosh1 (S3)], trigger: true }
    - { get: bits-service-release-tarball, passed: [migration-bosh1 (S3)], trigger: true}
    - { get: bits-service-release-version, passed: [migration-bosh1 (S3)] }
    - { get: stemcell, resource: boshlite-stemcell }
    - { get: ci-tasks, resource: git-bits-service-ci }
    - { get: git-cf-deployment, passed: [migration-bosh1 (S3)], trigger: true }
    - { get: git-deployment-vars }
    - { get: git-bits-service-release, passed: [migration-bosh1 (S3)], trigger: true }
  - task: Generate CF deployment manifest with bits-service enabled
    file: ci-tasks/tasks/bosh-interpolate.yml
    input_mapping:
      cf-deployment: git-cf-deployment
      deployment-vars: git-deployment-vars
    output_mapping:
      manifests: cf-with-bits-service-enabled
    params: *bosh-interpolate-boshlite1-bits-service-enabled
  - put: git-deployment-vars
    params:
      repository: updated/deployment-vars
  - put: boshlite1-deployment
    params: *params-deployment-bits-service-enabled
  - task: Run migration preparation tests
    attempts: 3
    file: ci-tasks/tasks/run-bits-service-migration-tests.yml
    input_mapping:
      bits-service-release: git-bits-service-release
      deployment-vars: git-deployment-vars
    params: *boshlite1-bsmt-preparation-params
    on_failure: *inform-pipeline-operator-bosh1-migration-tests
  - task: Generate CF deployment manifest with bits-service disabled
    file: ci-tasks/tasks/bosh-interpolate.yml
    input_mapping:
      cf-deployment: git-cf-deployment
      deployment-vars: git-deployment-vars
    output_mapping:
      manifests: cf-with-bits-service-disabled
    params: *bosh-interpolate-boshlite1-bits-service-disabled
  - put: git-deployment-vars
    params:
      repository: updated/deployment-vars
  - put: boshlite1-deployment
    params: *params-deployment-bits-service-disabled
  - task: Run migration verification tests
    attempts: 3
    file: ci-tasks/tasks/run-bits-service-migration-tests.yml
    input_mapping:
      bits-service-release: git-bits-service-release
    params: *boshlite1-bsmt-verification-params
    on_failure: *inform-pipeline-operator-bosh1-migration-tests
  on_failure: *notify

- name: manually-delete-cf-bosh2
  serial: true
  plan:
  - aggregate:
    - { get: ci-tasks, resource: git-bits-service-ci }
    - { get: cf-bosh2-deployment-events, params: { bump: major} }
  - task: delete-deployment
    file: ci-tasks/tasks/delete-deployment.yml
    params:
      <<: *bosh2-params
      DEPLOYMENT_NAME: cf
  - put: cf-bosh2-deployment-events
    params: { file: cf-bosh2-deployment-events/number }
  on_failure: *notify

- name: update-cloud-config-bosh2
  plan:
  - aggregate:
    - { get: bosh2-recreation-events, trigger: true }
    - { get: ci-tasks, resource: git-bits-service-ci }
    - { get: git-cf-deployment-cloud-config, trigger: true }
  - task: Update cloud-config
    file: ci-tasks/tasks/update-cloud-config.yml
    input_mapping:
      manifests: git-cf-deployment-cloud-config
    params:
      <<: *bosh2-params
      MANIFEST: *bosh-lite-cloud-config-path
  on_failure: *notify

# no-migration tests for webdav with cf-deployment
- name: migration-bosh2 (webdav)
  serial: true
  serial_groups: [cf-bosh2-deployment]
  plan:
  - aggregate:
    - { get: capi-release-tarball, passed: [create-capi-release], trigger: true }
    - { get: bits-service-release-tarball, passed: *run-system-tests-passed, trigger: true }
    - { get: bits-service-release-version, passed: *run-system-tests-passed }
    - { get: cf-bosh2-deployment-events, trigger: true }
    - { get: stemcell, resource: boshlite-stemcell }
    - { get: ci-tasks, resource: git-bits-service-ci, trigger: true }
    - { get: git-cf-deployment, trigger: true }
    - { get: bosh2-recreation-events, passed: [ update-cloud-config-bosh2 ], trigger: true }
    - { get: git-cf-deployment-cloud-config, passed: [ update-cloud-config-bosh2 ], trigger: true }
    - { get: git-deployment-vars }
    - { get: git-bits-service-release, passed: *run-system-tests-passed, trigger: true }
  - task: Generate CF deployment manifest with bits-service disabled
    file: ci-tasks/tasks/bosh-interpolate.yml
    input_mapping:
      cf-deployment: git-cf-deployment
      deployment-vars: git-deployment-vars
    output_mapping:
      manifests: cf-with-bits-service-disabled
    params: &bosh-interpolate-boshlite2-bits-service-disabled
      BOSH_TARGET: {{bosh2-target}}
      DEPLOYMENT_NAME: cf
      ENVIRONMENT_NAME: bosh2
      BLOBSTORE_TYPE: webdav
      IAAS: bosh-lite
      OPERATIONS: >
        -o ci-tasks/operations/disable-bits-service.yml
        -o ci-tasks/operations/bsmt-errands.yml
  - put: git-deployment-vars
    params:
      repository: updated/deployment-vars
  - put: boshlite2-deployment
    params: *params-deployment-bits-service-disabled
  - task: Run migration preparation tests
    attempts: 3
    file: ci-tasks/tasks/run-errand.yml
    params: *boshlite2-bsmt-preparation-errand-params
    on_failure: &inform-pipeline-operator-bosh2-migration-tests
      task: inform-pipeline-operator
      file: ci-tasks/tasks/echo.yml
      params:
        MESSAGE: |
            Consider doing a fresh deployment by manually running job
            [manually-delete-cf-bosh2]
            (https://flintstone.ci.cf-app.com/pipelines/bits-service/jobs/manually-delete-cf-bosh2)
  - task: Generate CF deployment manifest with bits-service enabled
    file: ci-tasks/tasks/bosh-interpolate.yml
    input_mapping:
      cf-deployment: git-cf-deployment
      deployment-vars: git-deployment-vars
    output_mapping:
      manifests: cf-with-bits-service-enabled
    params: &bosh-interpolate-boshlite2-bits-service-enabled
      <<: *bosh-interpolate-boshlite2-bits-service-disabled
      OPERATIONS: >
        -o ci-tasks/operations/bsmt-errands.yml
  - put: git-deployment-vars
    params:
      repository: updated/deployment-vars
  - put: boshlite2-deployment
    params: *params-deployment-bits-service-enabled
  - task: Run migration verification tests
    attempts: 3
    file: ci-tasks/tasks/run-errand.yml
    params: *boshlite2-bsmt-verification-errand-params
    on_failure: *inform-pipeline-operator-bosh2-migration-tests
  on_failure: *notify

- name: migration-backwards-bosh2
  serial: true
  serial_groups: [cf-bosh2-deployment]
  plan:
  - aggregate:
    - { get: capi-release-tarball, passed: [migration-bosh2 (webdav)], trigger: true }
    - { get: bits-service-release-tarball, passed: [migration-bosh2 (webdav)], trigger: true }
    - { get: bits-service-release-version, passed: [migration-bosh2 (webdav)] }
    - { get: stemcell, resource: boshlite-stemcell }
    - { get: ci-tasks, resource: git-bits-service-ci }
    - { get: git-cf-deployment, passed: [migration-bosh2 (webdav)], trigger: true }
    - { get: git-deployment-vars }
    - { get: git-bits-service-release, passed: [migration-bosh2 (webdav)], trigger: true }
  - task: Generate CF deployment manifest with bits-service enabled
    file: ci-tasks/tasks/bosh-interpolate.yml
    input_mapping:
      cf-deployment: git-cf-deployment
      deployment-vars: git-deployment-vars
    output_mapping:
      manifests: cf-with-bits-service-enabled
    params: *bosh-interpolate-boshlite2-bits-service-enabled
  - put: git-deployment-vars
    params:
      repository: updated/deployment-vars
  - put: boshlite2-deployment
    params: *params-deployment-bits-service-enabled
  - task: Run preparation tests
    file: ci-tasks/tasks/run-errand.yml
    attempts: 3
    params: *boshlite2-bsmt-preparation-errand-params
    on_failure: *inform-pipeline-operator-bosh2-migration-tests
  - task: Generate CF deployment manifest with bits-service disabled
    file: ci-tasks/tasks/bosh-interpolate.yml
    input_mapping:
      cf-deployment: git-cf-deployment
      deployment-vars: git-deployment-vars
    output_mapping:
      manifests: cf-with-bits-service-disabled
    params: *bosh-interpolate-boshlite2-bits-service-disabled
  - put: git-deployment-vars
    params:
      repository: updated/deployment-vars
  - put: boshlite2-deployment
    params: *params-deployment-bits-service-disabled
  - task: Run verification tests
    file: ci-tasks/tasks/run-errand.yml
    attempts: 3
    params: *boshlite2-bsmt-verification-errand-params
    on_failure: *inform-pipeline-operator-bosh2-migration-tests
  on_failure: *notify

# Infrastructure
- name: recreate-bosh-lite-1
  serial: true
  plan:
  - aggregate:
    - get: ci-tasks
      resource: git-bits-service-ci
    - get: bosh1-recreation-events
      params: { bump: major }
  - task: recreate-bosh-lite
    file: ci-tasks/tasks/recreate-bosh-lite.yml
    params:
      SSH_CONNECTION_STRING: root@10.155.171.3
      SSH_KEY: {{github-private-key}}
      BOSH_USERNAME: {{bosh-username}}
      BOSH_PASSWORD: {{bosh-password}}
      BOSH_DIRECTOR_IP: 192.168.50.4
      VAGRANT_GATEWAY: 192.168.50.1
  - put: bosh1-recreation-events
    params: { file: bosh1-recreation-events/number }
  on_failure: *notify

- name: recreate-bosh-lite-2
  serial: true
  plan:
  - aggregate:
    - get: ci-tasks
      resource: git-bits-service-ci
    - get: bosh2-recreation-events
      params: { bump: major }
  - task: recreate-bosh-lite
    file: ci-tasks/tasks/recreate-bosh-lite.yml
    params:
      SSH_CONNECTION_STRING: root@10.155.171.22
      SSH_KEY: {{github-private-key}}
      BOSH_USERNAME: {{bosh2-username}}
      BOSH_PASSWORD: {{bosh2-password}}
      BOSH_DIRECTOR_IP: 192.168.50.4
      VAGRANT_GATEWAY: 192.168.50.1
  - put: bosh2-recreation-events
    params: { file: bosh2-recreation-events/number }
  on_failure: *notify

- name: recreate-bosh-lite-acceptance
  serial: true
  plan:
  - aggregate:
    - get: git-bits-service-ci
    - get: bits-service
    - get: bits-service-release-tarball
    - get: capi-release-tarball
      passed: [create-capi-release]
  - task: recreate-bosh-lite
    file: git-bits-service-ci/tasks/recreate-bosh-lite.yml
    params:
      SSH_CONNECTION_STRING: root@10.155.248.164
      SSH_KEY: {{github-private-key}}
      BOSH_USERNAME: {{bosh-acceptance-username}}
      BOSH_PASSWORD: {{bosh-acceptance-password}}
      BOSH_DIRECTOR_IP: 192.168.150.4
      VAGRANT_GATEWAY: 192.168.150.1
  - aggregate:
    - task: upload-latest-bits-service-release
      file: git-bits-service-ci/tasks/upload-release.yml
      input_mapping:
        releases: bits-service-release-tarball
      params:
        BOSH_TARGET: {{bosh-acceptance-target}}
        BOSH_USERNAME: {{bosh-acceptance-username}}
        BOSH_PASSWORD: {{bosh-acceptance-password}}
        RELEASE_FILE: bits-service-release-tarball/*.tgz
    - task: upload-latest-capi-release
      file: git-bits-service-ci/tasks/upload-release.yml
      input_mapping:
        releases: capi-release-tarball
      params:
        BOSH_TARGET: {{bosh-acceptance-target}}
        BOSH_USERNAME: {{bosh-acceptance-username}}
        BOSH_PASSWORD: {{bosh-acceptance-password}}
        RELEASE_FILE: capi-release-tarball/*.tgz
  on_failure: *notify

- name: cleanup-bosh-1
  serial: true
  plan:
  - get: ci-tasks
    resource: git-bits-service-ci
  - get: nightly-timer
    trigger: true
  - task: cleanup-bosh
    file: ci-tasks/tasks/bosh-cleanup.yml
    params: *bosh1-params
  on_failure: *notify

- name: cleanup-bosh-2
  serial: true
  plan:
  - get: ci-tasks
    resource: git-bits-service-ci
  - get: nightly-timer
    trigger: true
  - task: cleanup-bosh
    file: ci-tasks/tasks/bosh-cleanup.yml
    params: *bosh2-params
  on_failure: *notify

- name: cleanup-bosh-aws
  serial: true
  plan:
  - get: ci-tasks
    resource: git-bits-service-ci
  - get: nightly-timer
    trigger: true
  - task: cleanup-bosh
    file: ci-tasks/tasks/bosh-cleanup.yml
    params: *aws-bosh-params
  on_failure: *notify

- name: cleanup-bosh-acceptance
  serial: true
  plan:
  - get: ci-tasks
    resource: git-bits-service-ci
  - get: nightly-timer
    trigger: true
  - task: cleanup-bosh
    file: ci-tasks/tasks/bosh-cleanup.yml
    params:
      BOSH_USERNAME: {{bosh-acceptance-username}}
      BOSH_PASSWORD: {{bosh-acceptance-password}}
      BOSH_TARGET: {{bosh-acceptance-target}}
  on_failure: *notify

- name: Run performance tests
  serial_groups: [cf-aws-deployment]
  serial: true
  plan:
    - aggregate:
      - { get: after-midnight, trigger: true }
      - { get: bits-service-release-tarball, passed: [Publish Dev Release] }
      - { get: capi-release-tarball, passed: [Publish Dev Release] }
      - { get: stemcell, resource: aws-stemcell }
      - { get: ci-tasks, resource: git-bits-service-ci, trigger: true }
      - { get: git-cf-deployment, trigger: true }
      - { get: git-deployment-vars }
    - task: Generate CF deployment manifest with bits-service disabled, 1 CC
      file: ci-tasks/tasks/bosh-interpolate.yml
      input_mapping:
        cf-deployment: git-cf-deployment
        deployment-vars: git-deployment-vars
      output_mapping:
        manifests: cf-with-bits-service-disabled
      params: *bosh-interpolate-aws-bits-service-disabled
    - put: git-deployment-vars
      params:
        repository: updated/deployment-vars
    - put: aws-diego-deployment
      attempts: 2
      params: *params-aws-deployment-bits-service-disabled
    # - task: Run performance tests
    #   file: ci-tasks/tasks/run-performance-tests.yml
    #   input_mapping:
    #     bits-service-release: git-bits-service-release
    #   params:
    #     BLUEMIX_USERNAME: {{bluemix_cloudfoundry_username}}
    #     BLUEMIX_PASSWORD: {{bluemix_cloudfoundry_password}}
    #     CF_DOMAIN: {{aws-cf1-domain}}
    #     PERFORMANCE_TEST_METRICS_PREFIX: bits-service.disabled.CCs.1
    #     LOOP_COUNT: 5
    - task: Create CF deployment manifest with Bits-Service enabled, 1 CC
      file: ci-tasks/tasks/bosh-interpolate.yml
      input_mapping:
        cf-deployment: git-cf-deployment
        deployment-vars: git-deployment-vars
      output_mapping:
        manifests: cf-with-bits-service-enabled
      params:
        <<: *bosh-interpolate-aws-bits-service-enabled
    - put: aws-diego-deployment
      attempts: 2
      params: *params-aws-deployment-bits-service-enabled
    # - task: Run performance tests
    #   file: ci-tasks/tasks/run-performance-tests.yml
    #   input_mapping:
    #     bits-service-release: git-bits-service-release
    #   params:
    #     BLUEMIX_USERNAME: {{bluemix_cloudfoundry_username}}
    #     BLUEMIX_PASSWORD: {{bluemix_cloudfoundry_password}}
    #     CF_DOMAIN: {{aws-cf1-domain}}
    #     PERFORMANCE_TEST_METRICS_PREFIX: bits-service.enabled.CCs.1
    #     LOOP_COUNT: 5
  on_failure: *notify
- name: Sync cf-deployment fork
  plan:
    - aggregate:
      - get: git-cf-deployment
      - get: git-cf-deployment-upstream
        trigger: true
      - get: ci-tasks
        resource: git-bits-service-ci
    - task: sync
      file: ci-tasks/tasks/sync-repo.yml
      input_mapping:
        fork-repo: git-cf-deployment
        upstream-repo: git-cf-deployment-upstream
      params: { BRANCH: develop }
    - put: git-cf-deployment
      params: { repository: synced-repo, force: true }

groups:
- name: all
  jobs:
  - run-unit-and-integration-tests
  - run-bits-service-client-tests
  - Publish gem
  - create-and-upload-release
  - deploy-with-S3
  - deploy-with-LOCAL
  - deploy-with-WEBDAV
  - deploy-and-test-with-s3-cf-softlayer
  - run-system-tests-S3
  - run-system-tests-LOCAL
  - run-system-tests-WEBDAV
  - create-capi-release
  - deploy-and-test-cf-diego-aws
  - enable-BITS-SERVICE-diego-and-run-CATs
  - migration-bosh1 (S3)
  - migration-bosh2 (webdav)
  - migration-backwards-bosh1
  - migration-backwards-bosh2
  - bump-bits-service-release
  - Publish Dev Release
  - Publish Final Release
  - update-cloud-config-bosh1
  - update-cloud-config-bosh2
  - Sync cf-deployment fork
- name: bits-service
  jobs:
  - run-unit-and-integration-tests
  - create-and-upload-release
  - deploy-with-S3
  - deploy-with-LOCAL
  - deploy-with-WEBDAV
  - deploy-and-test-with-s3-cf-softlayer
  - run-system-tests-S3
  - run-system-tests-LOCAL
  - run-system-tests-WEBDAV
  - bump-bits-service-release
- name: bits-service-client
  jobs:
  - run-bits-service-client-tests
  - Publish gem
- name: capi-release
  jobs:
  - create-capi-release
  - create-and-upload-release
  - deploy-and-test-cf-diego-aws
  - enable-BITS-SERVICE-diego-and-run-CATs
  - Publish Dev Release
- name: migration
  jobs:
  - migration-backwards-bosh1
  - migration-bosh1 (S3)
  - migration-backwards-bosh2
  - migration-bosh2 (webdav)
- name: infrastructure
  jobs:
  - recreate-bosh-lite-1
  - recreate-bosh-lite-2
  - recreate-bosh-lite-acceptance
  - cleanup-bosh-1
  - cleanup-bosh-2
  - cleanup-bosh-aws
  - cleanup-bosh-acceptance
  - manually-delete-cf-diego-aws
  - manually-delete-cf-bosh1
  - manually-delete-cf-bosh2
  - delete-deployment-bits-service-local
  - delete-deployment-bits-service-s3
  - delete-deployment-bits-service-webdav
- name: performance-tests
  jobs:
  - Publish Dev Release
  - Run performance tests

resource_types:
- name: bosh2-deployment
  type: docker-image
  source:
    repository: cloudfoundry/bosh-deployment-resource

- name: slack-notification
  type: docker-image
  source:
    repository: cfcommunity/slack-notification-resource
    tag: latest

resources:
- name: slack
  type: slack-notification
  source:
    url: {{slack-webhook}}

- name: aws-stemcell
  type: bosh-io-stemcell
  source: { name: bosh-aws-xen-hvm-ubuntu-trusty-go_agent }

- name: boshlite-stemcell
  type: bosh-io-stemcell
  source: { name: bosh-warden-boshlite-ubuntu-trusty-go_agent}

- name: softlayer-stemcell
  type: bosh-io-stemcell
  source: { name: bosh-softlayer-xen-ubuntu-trusty-go_agent }

- name: bits-service-release-tarball
  type: s3
  source: &s3-resource
    access_key_id: {{s3-blobstore-access-key-id}}
    secret_access_key: {{s3-blobstore-secret-access-key}}
    bucket: ci-bits-service-artifacts
    region_name: eu-west-1
    regexp: bits-service-release/bits-service-(.*).tgz
    private: false

- name: capi-release-tarball
  type: s3
  source:
    <<: *s3-resource
    regexp: capi-release/capi-(.*).tgz

- name: git-bits-service-ci
  type: git
  source:
    uri: git@github.com:cloudfoundry-incubator/bits-service-ci.git
    branch: master
    private_key: {{github-private-key}}
    paths: ["manifests/*", "scripts/*", "tasks/*", "operations/*"]

- name: git-cf-deployment-cloud-config
  type: git
  source:
    uri: https://github.com/petergtz/cf-deployment.git
    branch: develop
    paths:
      - &bosh-lite-cloud-config-path iaas-support/bosh-lite/cloud-config.yml

- name: git-cf-deployment
  type: git
  source:
    uri: git@github.com:petergtz/cf-deployment.git
    branch: develop
    private_key: {{github-private-key}}
- name: git-cf-deployment-upstream
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-deployment.git
    branch: develop

- name: git-deployment-vars
  type: git
  source:
    uri: git@github.com:cloudfoundry/bits-service-private-config.git
    branch: master
    private_key: {{github-private-key}}
    disable_ci_skip: true

- name: bits-service
  type: git
  source:
    uri: https://github.com/cloudfoundry-incubator/bits-service.git
    branch: master
    path: ["lib/*", "spec/*", "vendor/*", "app.rb", "config.rb", "Gemfile.lock"]

- name: git-bits-service-client
  type: git
  source:
    uri: git@github.com:cloudfoundry-incubator/bits-service-client.git
    branch: master
    private_key: {{github-private-key}}

- name: git-bits-service-release
  type: git
  source:
    uri: git@github.com:cloudfoundry-incubator/bits-service-release.git
    branch: master
    private_key: {{github-private-key}}

- name: bits-service-github-final-release
  type: github-release
  source:
    owner: cloudfoundry-incubator
    repository: bits-service-release
    access_token: {{github-access-token}}
    release: true
    drafts: true

- name: git-capi-release
  type: git
  source:
    uri: https://github.com/cloudfoundry/capi-release.git
    branch: master

- name: git-cf-acceptance-tests
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-acceptance-tests.git
    branch: master

- name: nightly-timer
  type: time
  source:
    interval: 24h

- name: aws-diego-deployment
  type: bosh-deployment
  source:
    target: {{aws-bosh-target}}
    username: {{aws-bosh-username}}
    password: {{aws-bosh-password}}
    deployment: cf

- name: boshlite1-deployment
  type: bosh-deployment
  source:
    target: {{bosh-target}}
    username: {{bosh-username}}
    password: {{bosh-password}}
    deployment: cf

- name: boshlite2-deployment
  type: bosh-deployment
  source:
    target: {{bosh2-target}}
    username: {{bosh2-username}}
    password: {{bosh2-password}}
    deployment: cf

- name: bosh-deployment-bits-service-local
  type: bosh2-deployment
  source: &sl-bosh-deployment-source
    target: {{sl-bosh-target}}
    username: {{sl-bosh-username}}
    password: {{sl-bosh-password}}
    client: {{sl-bosh-username}}
    client_secret: {{sl-bosh-password}}
    deployment: bits-service-local
    ca_cert: {{sl-bosh-ca-cert}}

- name: bosh-deployment-bits-service-webdav
  type: bosh2-deployment
  source:
    <<: *sl-bosh-deployment-source
    deployment: bits-service-webdav

- name: bosh-deployment-bits-service-s3
  type: bosh2-deployment
  source:
    <<: *sl-bosh-deployment-source
    deployment: bits-service-s3

- name: softlayer-cf-deployment
  type: bosh2-deployment
  source:
    <<: *sl-bosh-deployment-source
    deployment: cf

- name: capi-release-version
  type: semver
  source:
    driver: git
    uri: git@github.com:cloudfoundry-incubator/bits-service-ci.git
    branch: metadata
    file: version/capi-release/version
    private_key: {{github-private-key}}
    initial_version: 1.41.0-dev.1

- name: bits-service-release-version
  type: semver
  source:
    driver: git
    uri: git@github.com:cloudfoundry-incubator/bits-service-ci.git
    branch: metadata
    file: version/bits-service-release/version
    private_key: {{github-private-key}}
    initial_version: 0.0.0-dev.2

- name: cf-bosh1-deployment-events
  type: semver
  source: &deployment-events-source
    driver: git
    uri: git@github.com:cloudfoundry-incubator/bits-service-ci.git
    branch: events
    file: events/cf-bosh1/deployment-deleted
    private_key: {{github-private-key}}

- name: cf-bosh2-deployment-events
  type: semver
  source:
    <<: *deployment-events-source
    file: events/cf-bosh2/deployment-deleted

- name: bosh1-recreation-events
  type: semver
  source: &recreation-events-source
    driver: git
    uri: git@github.com:cloudfoundry-incubator/bits-service-ci.git
    branch: events
    file: events/bosh1/recreated
    private_key: {{github-private-key}}

- name: bosh2-recreation-events
  type: semver
  source:
    <<: *recreation-events-source
    file: events/bosh2/recreated

- name: cf-diego-aws-deployment-events
  type: semver
  source:
    <<: *deployment-events-source
    file: events/cf-diego-aws/deployment-deleted

- name: after-midnight
  type: time
  source:
    start: 12:00 AM
    stop: 1:00 AM

- name: bits-service-github-release
  type: github-release
  source:
    owner: cloudfoundry-incubator
    repository: bits-service-release
    access_token: {{github-access-token}}
    release: false
    pre_release: true
